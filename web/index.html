<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diary Schedule Assistant</title>
  <style>
    :root {
      --bg: #fff7fb;
      --panel: #ffffff;
      --line: #f2c6d8;
      --text: #5a2b3f;
      --sub: #8e5e74;
      --accent: #f5c5d8;
      --today: #fde8f0;
      --danger: #ffe6e6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Pretendard, "Malgun Gothic", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .app {
      max-width: 1280px;
      margin: 16px auto;
      padding: 0 12px 14px;
    }
    .top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .title {
      font-size: 34px;
      font-weight: 800;
      line-height: 1.1;
    }
    .sub {
      margin-top: 6px;
      color: var(--sub);
      font-size: 17px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 46px;
      padding: 8px 16px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--accent);
      font-size: 36px;
      font-size: clamp(20px, 1rem, 36px);
      font-weight: 700;
      white-space: nowrap;
    }
    .illust-wrap {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .grid {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      min-width: 0;
    }
    input, button, select {
      font: inherit;
      color: inherit;
    }
    input, select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }
    button {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 14px;
      background: var(--accent);
      font-weight: 700;
      cursor: pointer;
      box-shadow: none;
      transform: none;
      appearance: none;
    }
    button:hover { filter: brightness(0.98); }
    button.secondary { background: #fff; }
    button.danger { background: var(--danger); }

    .chat {
      height: 300px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px;
      line-height: 1.45;
      background: #fff;
    }
    .chat .a { color: #6f3d54; }
    .chat .u { color: #355c75; }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .tabs button.active {
      outline: 2px solid #d78eaa;
      outline-offset: 0;
    }

    .table-wrap { overflow: auto; }
    .table {
      width: 100%;
      min-width: 760px;
      border-collapse: collapse;
    }
    .table th, .table td {
      border-bottom: 1px solid #f3d9e4;
      text-align: left;
      padding: 8px 6px;
      white-space: nowrap;
    }
    .table th {
      color: #7f4f63;
      font-size: 13px;
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 6px 0 8px;
      gap: 10px;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
      width: 100%;
    }
    .calendar-wrap {
      overflow-x: hidden;
      overflow-y: hidden;
      padding-bottom: 2px;
    }
    .wday {
      font-weight: 700;
      color: #7f4f63;
      text-align: center;
      padding: 3px 0;
    }
    .cell {
      min-height: 104px;
      border: 1px solid #e2c6d3;
      border-radius: 8px;
      background: #fff;
      padding: 6px;
      overflow: hidden;
    }
    .cell.today { background: var(--today); }
    .day {
      font-weight: 700;
      margin-bottom: 4px;
    }
    .items {
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-line;
      color: #6d3f55;
    }

    .illust-box {
      width: 260px;
      height: 96px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
      position: relative;
    }
    #illustImg {
      position: absolute;
      left: 50%;
      top: 50%;
      max-width: none;
      transform: translate(-50%, -50%);
      user-select: none;
      pointer-events: none;
    }
    .illust-empty {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--sub);
      background: #fffdfa;
    }

    .illust-controls {
      margin: 10px 0;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fffdfa;
    }
    .illust-controls .rowline {
      display: grid;
      grid-template-columns: 88px 1fr;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .illust-controls input[type="range"] { padding: 0; }

    .hidden { display: none !important; }

    dialog {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
    }
    dialog form { min-width: 320px; }

    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
      .illust-wrap { align-items: flex-start; }
      .table { min-width: 640px; }
      .calendar { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div>
        <div class="title">Diary Planner</div>
        <div class="sub" id="todayText"></div>
      </div>
      <div class="illust-wrap">
        <div class="row">
          <div id="notiState" class="chip">Notifier: Off</div>
          <button id="notiBtn">Start Notifier</button>
        </div>
        <div class="illust-box" id="illustBox">
          <img id="illustImg" alt="illustration" class="hidden" />
          <div id="illustEmpty" class="illust-empty">PNG 이미지를 업로드해 주세요</div>
        </div>
        <div class="row">
          <input id="imageFile" type="file" accept=".png" class="hidden" />
          <button id="useImageBtn">Use My Image</button>
          <button id="editImageBtn">Edit Image</button>
        </div>
      </div>
    </div>

    <div id="illustControls" class="illust-controls hidden">
      <div class="rowline">
        <label for="scaleRange">Scale %</label>
        <input id="scaleRange" type="range" min="40" max="220" value="100" />
      </div>
      <div class="rowline">
        <label for="offsetXRange">Offset X</label>
        <input id="offsetXRange" type="range" min="-200" max="200" value="0" />
      </div>
      <div class="rowline">
        <label for="offsetYRange">Offset Y</label>
        <input id="offsetYRange" type="range" min="-160" max="160" value="0" />
      </div>
      <div class="row">
        <label>W <input id="boxW" type="number" min="180" max="520" value="260" style="width:90px" /></label>
        <label>H <input id="boxH" type="number" min="80" max="240" value="96" style="width:90px" /></label>
        <button id="applySizeBtn">Apply Size</button>
        <button id="resetImageBtn" class="secondary">Reset Image</button>
        <button id="doneImageBtn" class="secondary">Done</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="chat" id="chat"></div>
        <div class="row" style="margin-top:8px">
          <input id="input" placeholder="예: 4월 9일 파이널 발표 / 4월 9일까지 며칠 남았어?" />
          <button id="sendBtn">Send</button>
        </div>
      </div>

      <div class="card">
        <div class="tabs">
          <button data-tab="list" class="active">All Events</button>
          <button data-tab="today">Today</button>
          <button data-tab="month">Month Calendar</button>
        </div>

        <div id="tab-list" class="table-wrap">
          <table class="table">
            <thead>
              <tr><th>ID</th><th>Time</th><th>Title</th><th>D-day</th><th>State</th><th></th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="tab-today" class="table-wrap hidden">
          <table class="table">
            <thead>
              <tr><th>ID</th><th>Time</th><th>Title</th><th>D-day</th><th>State</th><th></th></tr>
            </thead>
            <tbody id="tbodyToday"></tbody>
          </table>
        </div>

        <div id="tab-month" class="hidden">
          <div class="calendar-nav">
            <button id="prevMonth">&lt;</button>
            <div id="monthLabel" style="font-weight:800"></div>
            <button id="nextMonth">&gt;</button>
          </div>
          <div class="calendar-wrap">
            <div id="calendar" class="calendar"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <dialog id="editDlg">
    <form method="dialog">
      <h3 style="margin-top:0">일정 수정</h3>
      <label>Title <input id="eTitle" /></label>
      <label>Date <input id="eDate" placeholder="YYYY-MM-DD" /></label>
      <label>Time <input id="eClock" placeholder="HH:MM" /></label>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button value="cancel" class="secondary">Cancel</button>
        <button id="saveEdit">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    const todayText = document.getElementById("todayText");
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const tbody = document.getElementById("tbody");
    const tbodyToday = document.getElementById("tbodyToday");
    const tabs = document.querySelectorAll(".tabs button");
    const notiBtn = document.getElementById("notiBtn");
    const notiState = document.getElementById("notiState");

    const imageFile = document.getElementById("imageFile");
    const useImageBtn = document.getElementById("useImageBtn");
    const editImageBtn = document.getElementById("editImageBtn");
    const illustControls = document.getElementById("illustControls");
    const illustBox = document.getElementById("illustBox");
    const illustImg = document.getElementById("illustImg");
    const illustEmpty = document.getElementById("illustEmpty");
    const scaleRange = document.getElementById("scaleRange");
    const offsetXRange = document.getElementById("offsetXRange");
    const offsetYRange = document.getElementById("offsetYRange");
    const boxW = document.getElementById("boxW");
    const boxH = document.getElementById("boxH");
    const applySizeBtn = document.getElementById("applySizeBtn");
    const resetImageBtn = document.getElementById("resetImageBtn");
    const doneImageBtn = document.getElementById("doneImageBtn");

    const dlg = document.getElementById("editDlg");
    let events = [];
    let monthCursor = new Date();
    monthCursor.setDate(1);
    let editId = null;
    let illustSettings = { scale: 100, offset_x: 0, offset_y: 0, width: 260, height: 96 };
    let saveTimer = null;

    function fmtDate(d) {
      return d.toISOString().slice(0, 10);
    }

    function append(role, msg) {
      const div = document.createElement("div");
      div.className = role === "assistant" ? "a" : "u";
      div.textContent = `${role}> ${msg}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function rowHtml(e) {
      return `<tr>
        <td>${e.id}</td>
        <td>${e.time_display}</td>
        <td>${e.title}</td>
        <td>${e.dday}</td>
        <td>${e.state}</td>
        <td>
          <div class="row">
            <button onclick="openEdit(${e.id})">Edit</button>
            <button class="danger" onclick="delEvent(${e.id})">Delete</button>
          </div>
        </td>
      </tr>`;
    }

    function renderTables() {
      tbody.innerHTML = events.map(rowHtml).join("");
      const today = fmtDate(new Date());
      tbodyToday.innerHTML = events.filter(e => e.date === today).map(rowHtml).join("");
    }

    function renderMonth() {
      const cal = document.getElementById("calendar");
      const label = document.getElementById("monthLabel");
      cal.innerHTML = "";

      const y = monthCursor.getFullYear();
      const m = monthCursor.getMonth();
      label.textContent = `${y}-${String(m + 1).padStart(2, "0")}`;

      ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach(w => {
        const d = document.createElement("div");
        d.className = "wday";
        d.textContent = w;
        cal.appendChild(d);
      });

      const first = new Date(y, m, 1);
      const firstWd = (first.getDay() + 6) % 7;
      const last = new Date(y, m + 1, 0).getDate();
      const today = fmtDate(new Date());

      const byDay = {};
      for (const e of events) {
        if (e.date.startsWith(`${y}-${String(m + 1).padStart(2, "0")}-`)) {
          if (!byDay[e.date]) byDay[e.date] = [];
          byDay[e.date].push(`${e.clock} ${e.title}`);
        }
      }

      for (let i = 0; i < 42; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        const day = i - firstWd + 1;
        if (day < 1 || day > last) {
          cal.appendChild(cell);
          continue;
        }

        const dateStr = `${y}-${String(m + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        if (dateStr === today) cell.classList.add("today");

        const items = byDay[dateStr] || [];
        const short = items.slice(0, 2).map(x => (x.length > 20 ? x.slice(0, 19) + "..." : x));

        const top = document.createElement("div");
        top.className = "day";
        top.textContent = items.length ? `${day} (${items.length})` : String(day);

        const body = document.createElement("div");
        body.className = "items";
        body.textContent = short.map(x => `- ${x}`).join("\n") + (items.length > 2 ? `\n... +${items.length - 2}` : "");

        cell.appendChild(top);
        cell.appendChild(body);
        cal.appendChild(cell);
      }
    }

    async function fetchEvents() {
      const res = await fetch("/api/events");
      const data = await res.json();
      events = data.events || [];
      renderTables();
      renderMonth();
    }

    async function ask() {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      append("you", text);

      const res = await fetch("/api/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      const data = await res.json();

      if (!res.ok) {
        append("assistant", data.error || "해석 실패");
        return;
      }
      if (data.type === "days_left") append("assistant", data.message);
      else append("assistant", `${data.type} ${data.events.length}개 등록/갱신`);

      await fetchEvents();
    }

    window.delEvent = async (id) => {
      await fetch(`/api/events/${id}`, { method: "DELETE" });
      await fetchEvents();
    };

    window.openEdit = (id) => {
      const e = events.find(x => x.id === id);
      if (!e) return;
      editId = id;
      document.getElementById("eTitle").value = e.title;
      document.getElementById("eDate").value = e.date;
      document.getElementById("eClock").value = e.clock;
      dlg.showModal();
    };

    document.getElementById("saveEdit").addEventListener("click", async (ev) => {
      ev.preventDefault();
      if (editId == null) return;
      await fetch(`/api/events/${editId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: document.getElementById("eTitle").value,
          date: document.getElementById("eDate").value,
          clock: document.getElementById("eClock").value
        })
      });
      dlg.close();
      await fetchEvents();
    });

    async function refreshNotifier() {
      const res = await fetch("/api/notifier/status");
      const data = await res.json();
      const running = !!data.running;
      notiBtn.dataset.running = running ? "1" : "0";
      notiBtn.textContent = running ? "Stop Notifier" : "Start Notifier";
      notiState.textContent = `Notifier: ${running ? "On" : "Off"}`;
    }

    notiBtn.addEventListener("click", async () => {
      const running = notiBtn.dataset.running === "1";
      if (running) await fetch("/api/notifier/stop", { method: "POST" });
      else await fetch("/api/notifier/start", { method: "POST" });
      await refreshNotifier();
    });

    function applyIllustSettings() {
      illustBox.style.width = `${illustSettings.width}px`;
      illustBox.style.height = `${illustSettings.height}px`;
      illustImg.style.transform = `translate(-50%, -50%) translate(${illustSettings.offset_x}px, ${illustSettings.offset_y}px) scale(${illustSettings.scale / 100})`;
      scaleRange.value = String(illustSettings.scale);
      offsetXRange.value = String(illustSettings.offset_x);
      offsetYRange.value = String(illustSettings.offset_y);
      boxW.value = String(illustSettings.width);
      boxH.value = String(illustSettings.height);
    }

    async function saveIllustSettings(partial) {
      const body = Object.assign({}, illustSettings, partial || {});
      const res = await fetch("/api/illustration/settings", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) return;
      const data = await res.json();
      illustSettings = data.settings;
      applyIllustSettings();
    }

    async function loadIllustSettings() {
      const res = await fetch("/api/illustration/settings");
      const data = await res.json();
      illustSettings = data;
      applyIllustSettings();
    }

    async function loadIllustImage() {
      const url = `/api/illustration/image?t=${Date.now()}`;
      const res = await fetch(url);
      if (!res.ok) {
        illustImg.classList.add("hidden");
        illustEmpty.classList.remove("hidden");
        return;
      }
      illustImg.src = url;
      illustImg.classList.remove("hidden");
      illustEmpty.classList.add("hidden");
    }

    function delayedSave(partial) {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => saveIllustSettings(partial), 120);
    }

    useImageBtn.addEventListener("click", () => imageFile.click());
    imageFile.addEventListener("change", async () => {
      if (!imageFile.files || !imageFile.files[0]) return;
      const fd = new FormData();
      fd.append("image", imageFile.files[0]);
      const res = await fetch("/api/illustration/upload", { method: "POST", body: fd });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: "업로드 실패" }));
        append("assistant", err.error || "업로드 실패");
        return;
      }
      append("assistant", "이미지 업로드 완료");
      await loadIllustImage();
    });

    editImageBtn.addEventListener("click", () => {
      const willShow = illustControls.classList.contains("hidden");
      illustControls.classList.toggle("hidden");
      editImageBtn.textContent = willShow ? "Hide Edit" : "Edit Image";
    });

    doneImageBtn.addEventListener("click", () => {
      illustControls.classList.add("hidden");
      editImageBtn.textContent = "Edit Image";
    });

    scaleRange.addEventListener("input", () => {
      illustSettings.scale = parseInt(scaleRange.value, 10);
      applyIllustSettings();
      delayedSave({ scale: illustSettings.scale });
    });

    offsetXRange.addEventListener("input", () => {
      illustSettings.offset_x = parseInt(offsetXRange.value, 10);
      applyIllustSettings();
      delayedSave({ offset_x: illustSettings.offset_x });
    });

    offsetYRange.addEventListener("input", () => {
      illustSettings.offset_y = parseInt(offsetYRange.value, 10);
      applyIllustSettings();
      delayedSave({ offset_y: illustSettings.offset_y });
    });

    applySizeBtn.addEventListener("click", async () => {
      illustSettings.width = parseInt(boxW.value, 10) || 260;
      illustSettings.height = parseInt(boxH.value, 10) || 96;
      await saveIllustSettings({ width: illustSettings.width, height: illustSettings.height });
    });

    resetImageBtn.addEventListener("click", async () => {
      illustSettings.scale = 100;
      illustSettings.offset_x = 0;
      illustSettings.offset_y = 0;
      await saveIllustSettings({ scale: 100, offset_x: 0, offset_y: 0 });
    });

    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        tabs.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.getElementById("tab-list").classList.toggle("hidden", tab !== "list");
        document.getElementById("tab-today").classList.toggle("hidden", tab !== "today");
        document.getElementById("tab-month").classList.toggle("hidden", tab !== "month");
      });
    });

    document.getElementById("prevMonth").addEventListener("click", () => {
      monthCursor.setMonth(monthCursor.getMonth() - 1);
      renderMonth();
    });

    document.getElementById("nextMonth").addEventListener("click", () => {
      monthCursor.setMonth(monthCursor.getMonth() + 1);
      renderMonth();
    });

    sendBtn.addEventListener("click", ask);
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") ask();
    });

    (async () => {
      const d = new Date();
      todayText.textContent = `Today: ${fmtDate(d)}`;
      append("assistant", "Ready.");
      await fetchEvents();
      await refreshNotifier();
      await loadIllustSettings();
      await loadIllustImage();
    })();
  </script>
</body>
</html>





